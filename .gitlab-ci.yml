
# 定义CI/CD运行的阶段
stages:
  - build

# 配置Maven构建作业
maven-build:
  # 使用最新的Java 8 Maven镜像
  image: maven:3-eclipse-temurin-8

  stage: build

  # 仅使用rules配置所有触发条件
  rules:
    # 同时满足：目标GitLab实例 + (main分支推送 或 合并请求)
    - if: >
        $CI_SERVER_URL != "https://gitlab.com" && $CI_COMMIT_BRANCH == "main"
      when: always
    # 其他所有情况不运行
    - when: never

  cache:
    paths:
      - .m2/repository/
      - .m2/wrapper/

  # 执行构建和部署的脚本
  script:
    # 复制项目中的settings.xml到Maven配置目录
    - echo "Using project's settings.xml for Maven configuration"
    - mkdir -p ~/.m2
    - cp ./.m2/settings.xml ~/.m2/settings.xml

    # 执行Maven构建和部署
    - echo "Running mvn clean deploy"
    - mvn clean deploy -U
